// app.js - Updated v·ªõi User Authentication System
require('./models/Product');
require('./models/Cart');
require('./models/Order'); // ‚Üê Th√™m d√≤ng n√†y ƒë·ªÉ ƒë·∫£m b·∫£o Order model ƒë∆∞·ª£c load
require('./models/Settings');
console.log('‚úÖ All models loaded successfully');
require('dotenv').config();
const express = require('express');
const path = require('path');
const fs = require('fs');
const bodyParser = require('body-parser');
const session = require('express-session');
const MongoStore = require('connect-mongo');
const flash = require('connect-flash'); // üì¶ NEW: Flash messages
const adminRoutes = require('./routes/admin');
// Import database connection
const connectDB = require('./config/database');

// Import routes
const homeRoutes = require('./routes/home');
const productRoutes = require('./routes/products');
const cartRoutes = require('./routes/cart');
const authRoutes = require('./routes/auth');     // üîê NEW: Auth routes
const userRoutes = require('./routes/user');     // üë§ NEW: User routes

const app = express();

// Error handling for environment variables
if (!process.env.MONGODB_URI) {
  console.error('‚ùå MONGODB_URI not found in environment variables');
  console.log('üí° Please check your .env file');
  process.exit(1);
}

// Connect to MongoDB with error handling
connectDB().catch(err => {
  console.error('‚ùå Failed to connect to MongoDB:', err.message);
  process.exit(1);
});

// Create data directories if they don't exist
const createDataDirectories = () => {
  const directories = [
    'data',
    'data/images',
    'data/images/products',
    'data/images/qr-codes',
    'data/images/banners',
    'data/images/icons',
    'data/uploads'
  ];
  
  directories.forEach(dir => {
    const dirPath = path.join(__dirname, dir);
    if (!fs.existsSync(dirPath)) {
      fs.mkdirSync(dirPath, { recursive: true });
      console.log(`üìÅ Created directory: ${dir}`);
    }
  });
  
  // Create .gitkeep for uploads folder
  const gitkeepPath = path.join(__dirname, 'data/uploads/.gitkeep');
  if (!fs.existsSync(gitkeepPath)) {
    fs.writeFileSync(gitkeepPath, '# Keep this directory in git\n');
  }
};

// Initialize data directories
createDataDirectories();

// View engine setup
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// Trust proxy for proper IP detection
app.set('trust proxy', 1);

// Middleware
app.use(bodyParser.json({ limit: '10mb' }));
app.use(bodyParser.urlencoded({ extended: true, limit: '10mb' }));

// Static files serving
app.use(express.static(path.join(__dirname, 'public')));

// üñºÔ∏è STATIC FILE SERVING FOR DATA FOLDER
app.use('/assets', express.static(path.join(__dirname, 'data/images'), {
  maxAge: '1d',
  etag: true,
  lastModified: true
}));

app.use('/uploads', express.static(path.join(__dirname, 'data/uploads'), {
  maxAge: '1h',
  etag: true,
  lastModified: true
}));

// üîç MIDDLEWARE: Log static file requests for debugging
app.use('/assets', (req, res, next) => {
  const filePath = path.join(__dirname, 'data/images', req.path);
  if (!fs.existsSync(filePath)) {
    console.log(`‚ö†Ô∏è  Asset not found: ${req.path}`);
  }
  next();
});

// üóÇÔ∏è SESSION CONFIGURATION
const sessionConfig = {
  secret: process.env.SESSION_SECRET || 'sportshop-super-secret-key-change-in-production',
  name: 'sportshop.sid', // Custom session name
  resave: false,
  saveUninitialized: false,
  store: MongoStore.create({
    mongoUrl: process.env.MONGODB_URI,
    touchAfter: 24 * 3600, // lazy session update
    crypto: {
      secret: process.env.SESSION_SECRET || 'sportshop-crypto-secret'
    },
    dbName: 'sportshop',
    collectionName: 'sessions'
  }),
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000, // 24 hours
    sameSite: 'lax'
  },
  rolling: true // Reset expiration on activity
};

// Apply session middleware
app.use(session(sessionConfig));
app.use((req, res, next) => {
  // Make user available in all views
  res.locals.user = req.session?.user || null;
  res.locals.isAuthenticated = !!req.session?.user;
  next();
});
// üì® FLASH MESSAGES MIDDLEWARE
app.use(flash());

// üìä REQUEST LOGGING MIDDLEWARE
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  const userInfo = req.session?.user ? 
    `${req.session.user.email} (${req.session.user.role})` : 
    'Guest';
  
  console.log(`${timestamp} | ${req.method} ${req.path} | ${userInfo} | ${req.ip}`);
  next();
});

// üîê GLOBAL USER CONTEXT MIDDLEWARE
// Make user information available in all views
app.use((req, res, next) => {
  // User information
  res.locals.user = req.session.user || null;
  res.locals.isLoggedIn = !!req.session.user;
  res.locals.isAdmin = req.session.user?.role === 'admin';
  res.locals.isVerified = req.session.user?.isVerified || false;
  
  // Flash messages
  res.locals.flashMessages = {
    error: req.flash('error'),
    success: req.flash('success'),
    info: req.flash('info'),
    warning: req.flash('warning')
  };
  
  // Current year for footer
  res.locals.currentYear = new Date().getFullYear();
  
  // Environment info
  res.locals.isDevelopment = process.env.NODE_ENV !== 'production';
  
  next();
});

app.use(async (req, res, next) => {
  try {
    const Cart = require('./models/Cart');
    const sessionId = req.sessionID;
    const userId = req.session.user?.id || null;
    
    console.log('üõí Cart middleware - SessionID:', sessionId, 'UserID:', userId);
    
    const cart = await Cart.findBySessionId(sessionId, userId);
    
    // ƒê·∫£m b·∫£o cart count ch√≠nh x√°c
    res.locals.cartItemCount = cart ? cart.totalItems : 0;
    res.locals.cartTotal = cart ? cart.getFormattedFinalTotal() : '0‚Ç´';
    
    console.log('üìä Cart count set to:', res.locals.cartItemCount);
    
  } catch (error) {
    console.error('‚ùå Cart context error:', error);
    res.locals.cartItemCount = 0;
    res.locals.cartTotal = '0‚Ç´';
  }
  
  next();
});
// üîí SECURITY HEADERS MIDDLEWARE
app.use((req, res, next) => {
  // Basic security headers
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  // Remove powered by header
  res.removeHeader('X-Powered-By');
  
  next();
});

// üåê ROUTES CONFIGURATION
console.log('üöÄ Configuring routes...');

// Main application routes
app.use('/', homeRoutes);
app.use('/products', productRoutes);
app.use('/cart', cartRoutes);

// üîê Authentication routes
app.use('/auth', authRoutes);
console.log('‚úÖ Auth routes mounted at /auth');

// üë§ User account routes
app.use('/user', userRoutes);
console.log('‚úÖ User routes mounted at /user');
app.use('/admin', adminRoutes);
console.log('‚úÖ Admin routes mounted at /admin');
// üì± API routes
app.use('/api/auth', authRoutes); // Auth API endpoints
app.use('/api/user', userRoutes); // User API endpoints

// üè† UTILITY ROUTES

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    version: require('./package.json').version || '1.0.0',
    environment: process.env.NODE_ENV || 'development',
    database: 'Connected',
    session: req.session ? 'Active' : 'Inactive',
    user: req.session?.user ? 'Authenticated' : 'Guest'
  });
});

// Robots.txt
app.get('/robots.txt', (req, res) => {
  res.type('text/plain');
  res.send(`User-agent: *
Disallow: /admin/
Disallow: /api/
Disallow: /auth/
Disallow: /user/
Disallow: /cart/
Allow: /
Allow: /products/
Allow: /about
Allow: /contact

Sitemap: ${req.protocol}://${req.get('host')}/sitemap.xml`);
});

// Basic sitemap
app.get('/sitemap.xml', (req, res) => {
  const baseUrl = `${req.protocol}://${req.get('host')}`;
  const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>${baseUrl}/</loc>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
  </url>
  <url>
    <loc>${baseUrl}/products</loc>
    <changefreq>daily</changefreq>
    <priority>0.8</priority>
  </url>
  <url>
    <loc>${baseUrl}/about</loc>
    <changefreq>monthly</changefreq>
    <priority>0.5</priority>
  </url>
  <url>
    <loc>${baseUrl}/contact</loc>
    <changefreq>monthly</changefreq>
    <priority>0.5</priority>
  </url>
</urlset>`;
  
  res.type('application/xml');
  res.send(sitemap);
});

// üîß ADMIN PANEL ROUTES (Placeholder)
app.get('/admin', (req, res) => {
  // TODO: Implement admin panel
  if (!req.session.user || req.session.user.role !== 'admin') {
    return res.status(403).render('error', {
      title: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p - SportShop',
      error: 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã',
      currentPage: 'error'
    });
  }
  
  res.render('admin/dashboard', {
    title: 'Qu·∫£n tr·ªã - SportShop',
    currentPage: 'admin'
  });
});

// üìÑ STATIC PAGES
app.get('/about', (req, res) => {
  res.render('pages/about', {
    title: 'Gi·ªõi thi·ªáu - SportShop',
    currentPage: 'about'
  });
});

app.get('/contact', (req, res) => {
  res.render('pages/contact', {
    title: 'Li√™n h·ªá - SportShop',
    currentPage: 'contact'
  });
});

app.get('/privacy', (req, res) => {
  res.render('pages/privacy', {
    title: 'Ch√≠nh s√°ch b·∫£o m·∫≠t - SportShop',
    currentPage: 'privacy'
  });
});

app.get('/terms', (req, res) => {
  res.render('pages/terms', {
    title: 'ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng - SportShop',
    currentPage: 'terms'
  });
});

// üö´ ERROR HANDLING MIDDLEWARE

// 404 Handler - Must be after all route definitions
app.use((req, res) => {
  console.log(`‚ùå 404 - Page not found: ${req.method} ${req.originalUrl}`);
  
  res.status(404);
  
  // API 404
  if (req.originalUrl.startsWith('/api/')) {
    return res.json({
      success: false,
      message: 'API endpoint kh√¥ng t·ªìn t·∫°i',
      path: req.originalUrl
    });
  }
  
  // Regular 404 page
  res.render('404', {
    title: 'Trang kh√¥ng t√¨m th·∫•y - SportShop',
    currentPage: '404',
    requestedUrl: req.originalUrl
  });
});

// Global Error Handler
app.use((err, req, res, next) => {
  console.error('üí• Unhandled Error:', {
    error: err.message,
    stack: err.stack,
    url: req.originalUrl,
    method: req.method,
    user: req.session?.user?.email || 'Guest',
    timestamp: new Date().toISOString()
  });
  
  // Don't leak error details in production
  const isDevelopment = process.env.NODE_ENV !== 'production';
  
  res.status(err.status || 500);
  
  // API Error Response
  if (req.originalUrl.startsWith('/api/')) {
    return res.json({
      success: false,
      message: isDevelopment ? err.message : 'C√≥ l·ªói x·∫£y ra tr√™n m√°y ch·ªß',
      ...(isDevelopment && { stack: err.stack })
    });
  }
  
  // Regular Error Page
  res.render('error', {
    title: 'L·ªói h·ªá th·ªëng - SportShop',
    currentPage: 'error',
    error: isDevelopment ? err.message : 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.',
    ...(isDevelopment && { stack: err.stack })
  });
});

// üîÑ GRACEFUL SHUTDOWN
process.on('SIGTERM', () => {
  console.log('üõë SIGTERM received. Shutting down gracefully...');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('üõë SIGINT received. Shutting down gracefully...');
  process.exit(0);
});

// üéØ STARTUP
const PORT = process.env.PORT || 3000;
const HOST = process.env.HOST || 'localhost';

app.listen(PORT, HOST, () => {
  console.log('\nüéâ SportShop Server Started Successfully!');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log(`üåê Server: http://${HOST}:${PORT}`);
  console.log(`üìä Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`üóÑÔ∏è  Database: ${process.env.MONGODB_URI ? 'Connected' : 'Not configured'}`);
  console.log(`üîê Session Store: MongoDB`);
  console.log(`üì¶ Static Assets: /assets -> ./data/images`);
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('\nüîó Available Routes:');
  console.log('   üè† Homepage: /');
  console.log('   üõçÔ∏è  Products: /products');
  console.log('   üõí Cart: /cart');
  console.log('   üîê Auth: /auth/login, /auth/register');
  console.log('   üë§ User: /user/account, /user/profile');
  console.log('   ‚ö° Admin: /admin (admin only)');
  console.log('   üè• Health: /health');
  console.log('   üìö API Docs: /api/docs (coming soon)');
  console.log('\n‚ú® New Features:');
  console.log('   ‚úÖ User Registration & Login');
  console.log('   ‚úÖ Session Management');
  console.log('   ‚úÖ Cart Persistence (Guest + User)');
  console.log('   ‚úÖ Role-based Access Control');
  console.log('   ‚úÖ Password Security');
  console.log('   ‚úÖ Flash Messages');
  console.log('   ‚úÖ User Profile Management');
  console.log('   ‚úÖ Address Management');
  console.log('   ‚úÖ Favorites System');
  console.log('\nüöÄ Ready for connections!');
});

module.exports = app;